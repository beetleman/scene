version: "2"

services:
  app:
    extends:
      file: ./docker-compose-base.yml
      service: dev-base
    depends_on:
      - truffle
    links:
      - testrpc
      - redis
    volumes:
      - m2-repo:/root/.m2
    command: app

  repl:
    links:
      - testrpc
      - redis
    depends_on:
      - truffle
    extends:
      file: ./docker-compose-base.yml
      service: dev-base
    volumes:
      - m2-repo:/root/.m2
    command: repl

  release:
    extends:
      file: ./docker-compose-base.yml
      service: dev-base
    volumes:
      - m2-repo:/root/.m2
    command: release

  test-watch:
    links:
      - testrpc
      - redis
    depends_on:
      - truffle
    extends:
      file: ./docker-compose-base.yml
      service: test-base
    volumes:
      - m2-repo:/root/.m2
    command: lein test-watch

  test:
    links:
      - testrpc
      - redis
    depends_on:
      - truffle
    extends:
      file: ./docker-compose-base.yml
      service: test-base
    volumes:
      - m2-repo:/root/.m2
    command: lein test

  testrpc:
    image: beetleman/docker-eth-env:0.0.3

  truffle:
    build:
      context: .
      dockerfile: ./development/Dockerfile.truffle
    volumes:
      - ./development:/app
    environment:
      - RPC_HOST=testrpc
    links:
      - testrpc

  redis:
    image: redis:4-alpine

volumes:
  m2-repo:
